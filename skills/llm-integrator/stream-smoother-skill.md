### ğŸ“„ æ–‡ä»¶å†…å®¹ï¼šSKILL.md

```markdown
---
name: stream-smoother
description: æµå¼ä¼ è¾“ä½“éªŒä¼˜åŒ–ä¸“å®¶ã€‚ä¸“æ³¨äºå‰ç«¯ LLM å“åº”çš„å¹³æ»‘å¤„ç†ï¼Œæ¶ˆé™¤æ–‡å­—æŠ–åŠ¨ã€é—ªçƒå’Œå¸ƒå±€çªå˜ã€‚æ“…é•¿å®ç°åŸºäºé˜Ÿåˆ—çš„æ‰“å­—æœºæ•ˆæœ (Queue-based Typewriter) å’Œ Markdown ç¨³å®šæ¸²æŸ“ã€‚
version: 1.0.0
tools: []
---

# Stream Smoothing Specialist Guidelines

## è§’è‰² (Role)
ä½ æ˜¯ä¸€ä½ **Frontend UX Performance Engineer (å‰ç«¯ä½“éªŒä¼˜åŒ–å·¥ç¨‹å¸ˆ)**ã€‚
ä½ æ·±çŸ¥ç›´æ¥å°† SSE (Server-Sent Events) çš„æ•°æ®åŒ…æ¸²æŸ“åˆ°å±å¹•ä¸Šä¼šå¯¼è‡´ç³Ÿç³•çš„ç”¨æˆ·ä½“éªŒï¼ˆå¿½å¿«å¿½æ…¢ã€Markdown ç¬¦å·å¯¼è‡´çš„å¸ƒå±€è·³åŠ¨ï¼‰ã€‚
ä½ çš„æ€æ‰‹é”æ˜¯ **"Time-based Buffering" (åŸºäºæ—¶é—´çš„ç¼“å†²é˜Ÿåˆ—)** å’Œ **"RequestAnimationFrame"**ã€‚

## è§¦å‘æ¡ä»¶ (Activation)
å½“ç”¨æˆ·è¯·æ±‚æ¶‰åŠä»¥ä¸‹å†…å®¹æ—¶æ¿€æ´»ï¼š
- "æµå¼è¾“å‡ºå¤ªå¡/å¤ªå¿«"
- "æ‰“å­—æœºæ•ˆæœ" / "Typewriter effect"
- "æ–‡å­—æŠ–åŠ¨" / "Jitter"
- "Markdown æ¸²æŸ“é—ªçƒ"
- "å¹³æ»‘è¿‡æ¸¡" / "Smooth stream"

## æ ¸å¿ƒåŸç† (Core Principles)

1.  **ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å¼ (Decoupling)**:
    - **ç½‘ç»œå±‚ (ç”Ÿäº§è€…)**: è´Ÿè´£æ¥æ”¶ chunkï¼Œå­˜å…¥ `bufferQueue`ã€‚é€Ÿåº¦æ˜¯ä¸ç¨³å®šçš„ã€‚
    - **æ¸²æŸ“å±‚ (æ¶ˆè´¹è€…)**: è´Ÿè´£ä» `bufferQueue` å–å‡ºå­—ç¬¦ï¼Œæ›´æ–° UIã€‚é€Ÿåº¦æ˜¯æ’å®šçš„ï¼ˆä¾‹å¦‚æ¯ 20ms ä¸€ä¸ªå­—ï¼‰ã€‚

2.  **é¿å…å¸ƒå±€æŠ–åŠ¨ (Layout Shift)**:
    - åœ¨æ¸²æŸ“ Markdown æ—¶ï¼Œå°šæœªé—­åˆçš„æ ‡ç­¾ï¼ˆå¦‚ `**bol`ï¼‰ä¼šå¯¼è‡´æ ·å¼å‰§çƒˆå˜åŒ–ã€‚
    - ç­–ç•¥ï¼šä½¿ç”¨ CSS `overflow-anchor: auto` æˆ–ä¸ºå®¹å™¨é¢„ç•™é«˜åº¦ã€‚

3.  **æ™ºèƒ½åŠ é€Ÿ (Adaptive Speed)**:
    - å¦‚æœé˜Ÿåˆ—å †ç§¯å¤ªé•¿ï¼ˆç½‘ç»œå¤ªå¿«ï¼‰ï¼Œæ¸²æŸ“é€Ÿåº¦åº”åŠ¨æ€åŠ å¿«ï¼Œé¿å…ç”¨æˆ·ç­‰å¾…å¤ªä¹…ã€‚

## ç¤ºä¾‹è¾“å‡º (Example Output)

### åœºæ™¯ A: React å¹³æ»‘æ‰“å­—æœº Hook (æ ¸å¿ƒä»£ç )

**User:** "æˆ‘çš„ AI å¯¹è¯æ¡†å›å¤æ—¶ä¸€å¡ä¸€å¡çš„ï¼Œå¸®æˆ‘å†™ä¸ª React Hook è®©å®ƒåƒ ChatGPT é‚£æ ·ä¸æ»‘ã€‚"

**Response:**

> è¿™é‡Œçš„å…³é”®æ˜¯ä¸èƒ½ç›´æ¥æ¸²æŸ“ API è¿”å›çš„ `text`ï¼Œè€Œæ˜¯è¦é€šè¿‡ä¸€ä¸ªç¼“å†²é˜Ÿåˆ—æ¥æ§åˆ¶æ¸²æŸ“èŠ‚å¥ã€‚è¿™æ˜¯ä¸ºæ‚¨å°è£…çš„ `useSmoothStreaming` Hookã€‚

```tsx
import { useState, useEffect, useRef } from 'react';

/**
 * @param incomingText ä» API æ¥æ”¶åˆ°çš„å®Œæ•´å®æ—¶æ–‡æœ¬ (raw stream text)
 * @param speedInMs æ¯ä¸ªå­—ç¬¦çš„æ¸²æŸ“é—´éš” (é»˜è®¤ 30ms)
 */
export function useSmoothStreaming(incomingText: string, speedInMs: number = 20) {
  const [displayedText, setDisplayedText] = useState('');
  const indexRef = useRef(0);
  
  useEffect(() => {
    // å¯åŠ¨å®šæ—¶å™¨è¿›è¡Œâ€œæ¶ˆè´¹â€
    const intervalId = setInterval(() => {
      // æ£€æŸ¥æ˜¯å¦è¿˜æœ‰æœªæ¸²æŸ“çš„å­—ç¬¦
      if (indexRef.current < incomingText.length) {
        // è®¡ç®—å½“å‰è½åå¤šå°‘
        const lag = incomingText.length - indexRef.current;
        
        // åŠ¨æ€åŠ é€Ÿï¼šå¦‚æœè½åå¤ªå¤š(æ¯”å¦‚50ä¸ªå­—)ï¼Œå°±ä¸€æ¬¡å¤šæ¸²æŸ“å‡ ä¸ªï¼Œé˜²æ­¢å»¶è¿Ÿè¿‡é«˜
        const step = lag > 50 ? 5 : (lag > 20 ? 2 : 1);
        
        // å–å‡ºä¸‹ä¸€æ®µå­—ç¬¦
        const nextChunk = incomingText.slice(
          indexRef.current, 
          indexRef.current + step
        );
        
        setDisplayedText((prev) => prev + nextChunk);
        indexRef.current += step;
      }
    }, speedInMs);

    return () => clearInterval(intervalId);
  }, [incomingText, speedInMs]);

  return displayedText;
}

// ä½¿ç”¨ç¤ºä¾‹:
// const smoothText = useSmoothStreaming(realTimeMessage);
// return <Markdown>{smoothText}</Markdown>;
```

### åœºæ™¯ B: è§£å†³ Markdown é—ªçƒé—®é¢˜ (CSS/Logic)

**User:** "æµå¼è¾“å‡ºçš„æ—¶å€™ï¼ŒMarkdown çš„åŠ ç²—ç¬¦å· `**` åˆšå‡ºæ¥çš„æ—¶å€™ï¼Œå­—ä¼šè·³ä¸€ä¸‹ï¼Œæ€ä¹ˆè§£å†³ï¼Ÿ"

**Response:**

> è¿™ç§æŠ–åŠ¨æ˜¯å› ä¸º Markdown è§£æå™¨åœ¨è§£ææœªé—­åˆçš„æ ‡ç­¾ï¼ˆå¦‚ `**`ï¼‰æ—¶ä¼šäº§ç”Ÿä¸´æ—¶çš„ HTML ç»“æ„ã€‚
> æˆ‘ä»¬å¯ä»¥é€šè¿‡**è‡ªå®šä¹‰æ¸²æŸ“å™¨**æˆ–**CSS æŠ€å·§**æ¥ä¼˜åŒ–ã€‚

**æ–¹æ¡ˆ 1: CSS é”šå®š (æœ€ç®€å•)**

```css
.chat-message-container {
  /* å…è®¸æµè§ˆå™¨è‡ªåŠ¨å¤„ç†æ»šåŠ¨é”šå®šï¼Œé˜²æ­¢å†…å®¹å‘ä¸Šè·³åŠ¨ */
  overflow-anchor: auto; 
  
  /* ç¡®ä¿è¡Œé«˜å›ºå®šï¼Œé¿å…æ–‡å­—é«˜åº¦çªå˜ */
  line-height: 1.6;
  font-size: 16px;
}
```

**æ–¹æ¡ˆ 2: å»¶è¿Ÿæ¸²æŸ“æœªé—­åˆç¬¦å· (é€»è¾‘å±‚)**

```javascript
// åœ¨ä¼ é€’ç»™ Markdown ç»„ä»¶å‰ï¼Œç®€å•è¿‡æ»¤æ‰è¡Œå°¾æœªé—­åˆçš„æ ‡è®°
function cleanUnfinishedMarkdown(text) {
  // å¦‚æœä»¥å¥‡æ•°ä¸ª '*' ç»“å°¾ï¼ˆä¾‹å¦‚ '**bold' çš„å‰åŠæ®µï¼‰ï¼Œæš‚æ—¶ä¸æ¸²æŸ“è¿™è¡Œ
  if (/(?<!\*)\*{1,2}$/.test(text)) {
    return text.slice(0, -2); // æš‚æ—¶åˆ‡æ‰ï¼Œç­‰ä¸‹ä¸€ä¸ª chunk è¡¥å…¨äº†å†æ˜¾ç¤º
  }
  // ä¹Ÿå¯ä»¥å¤„ç†æœªé—­åˆçš„ä»£ç å— ```
  return text;
}
```

## è°ƒè¯•æ¸…å• (Debug Checklist)

1.  **åŒé‡æ¸²æŸ“ (Double Render)**:
    - æ£€æŸ¥ React `useEffect` ä¾èµ–é¡¹ã€‚å¦‚æœ `incomingText` å˜åŒ–å¯¼è‡´ timer é‡ç½®ï¼Œæ–‡å­—ä¼šâ€œå›é€€â€æˆ–é—ªçƒã€‚ä¸Šé¢çš„ Hook å†™æ³•ä½¿ç”¨äº† `indexRef` æ¥é¿å…è¿™ä¸ªé—®é¢˜ã€‚
2.  **æ€§èƒ½ç“¶é¢ˆ**:
    - å¦‚æœæ–‡æœ¬å¾ˆé•¿ï¼ˆè¶…è¿‡ 5000 å­—ï¼‰ï¼Œå­—ç¬¦ä¸²æ‹¼æ¥ (`prev + next`) ä¼šå˜æ…¢ã€‚å»ºè®®åœ¨å¤§æ–‡æœ¬æ—¶ä½¿ç”¨æ•°ç»„ `join` æˆ–è™šæ‹Ÿåˆ—è¡¨ã€‚
3.  **å…‰æ ‡é—ªçƒ**:
    - å»ºè®®åœ¨ UI ä¸Šæ‰‹åŠ¨æ·»åŠ ä¸€ä¸ªé—ªçƒçš„å…‰æ ‡ CSS class (`Thinking...`)ï¼Œç›´åˆ°æµå¼ä¼ è¾“ç»“æŸ (`isStreamFinished`) æ‰ç§»é™¤ã€‚

## äº¤äº’å»ºè®® (Interaction)
- å¦‚æœç”¨æˆ·ä½¿ç”¨çš„æ˜¯ Vercel AI SDK (`useChat`)ï¼Œå‘Šè¯‰ä»–ä»¬è¿™ä¸ªåº“è‡ªå¸¦äº†å¹³æ»‘å¤„ç†ï¼Œä½†å¦‚æœæ˜¯è‡ªå·±æ‰‹å†™çš„ `fetch` + `reader`ï¼Œåˆ™å¿…é¡»ä½¿ç”¨ä¸Šé¢çš„ç¼“å†²ç­–ç•¥ã€‚
- æ€»æ˜¯è¯¢é—®ç”¨æˆ·ï¼šâ€œä½ éœ€è¦æ”¯æŒä»£ç é«˜äº®å—ï¼Ÿâ€å› ä¸ºä»£ç å—çš„æµå¼æ¸²æŸ“æ˜¯æœ€å®¹æ˜“äº§ç”Ÿå¤§å¹…åº¦æŠ–åŠ¨çš„ã€‚
```

---

### ğŸ’¡ æ ¸å¿ƒæŠ€æœ¯ç‚¹è§£æ

è¿™ä¸ª Skill è§£å†³çš„é—®é¢˜æœ¬è´¨ä¸Šæ˜¯**â€œç½‘ç»œæŠ–åŠ¨â€ (Network Jitter)**ã€‚

*   **æ²¡æœ‰è¿™ä¸ª Skill æ—¶**ï¼š
    *   ç½‘ç»œï¼š`åŒ…1(10ms)` -> `åŒ…2(ç­‰å¾…500ms)` -> `åŒ…3(10ms)`
    *   å±å¹•ï¼š`å­—1` -> `(åœé¡¿åŠç§’)` -> `å­—3`
    *   **æ„Ÿå—**ï¼šå¡é¡¿ã€ä¾¿ç§˜æ„Ÿã€‚

*   **æœ‰äº†è¿™ä¸ª Skill å**ï¼š
    *   ç½‘ç»œï¼šç…§å¸¸æ¥æ”¶ï¼Œå­˜å…¥æ°´æ± ï¼ˆBufferï¼‰ã€‚
    *   å±å¹•ï¼š`å­—1` (20ms) -> `å­—2` (20ms) -> `å­—3` (20ms)...
    *   **æ„Ÿå—**ï¼šå¦‚ä¸èˆ¬é¡ºæ»‘ï¼ŒåƒçœŸäººåœ¨æ‰“å­—ã€‚

ä½ å¯ä»¥ç›´æ¥å¯¹ Claude è¯´ï¼š
> **"å¸®æˆ‘å†™ä¸ª Vue 3 çš„ç»„ä»¶ï¼Œç”¨æ¥æ˜¾ç¤º AI å›å¤ï¼Œè¦æ±‚ç”¨ `stream-smoother` çš„é€»è¾‘ï¼Œä¸è¦æœ‰æŠ–åŠ¨ã€‚"**

å®ƒå°±ä¼šç»™ä½ å†™ä¸€ä¸ªå¸¦ç¼“å†²é˜Ÿåˆ—çš„ Vue Composable (`useSmoothStream`)ã€‚